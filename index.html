<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZHVI Median Home Prices by ZIP Code (2000-2025)</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: #0f172a;
            color: #e2e8f0;
        }

        #map {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 1;
        }

        /* Control Panel */
        .control-panel {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 1000;
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 16px;
            padding: 24px;
            width: 320px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5),
                        0 0 0 1px rgba(255, 255, 255, 0.1);
        }

        .panel-header {
            margin-bottom: 20px;
        }

        .panel-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #f8fafc;
            margin-bottom: 4px;
        }

        .panel-subtitle {
            font-size: 0.875rem;
            color: #94a3b8;
        }

        .control-group {
            margin-bottom: 20px;
        }

        .control-label {
            display: block;
            font-size: 0.75rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #64748b;
            margin-bottom: 8px;
        }

        /* State Select */
        .state-select {
            width: 100%;
            padding: 12px 16px;
            background: rgba(30, 41, 59, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            color: #f8fafc;
            font-size: 0.95rem;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.2s ease;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%2394a3b8'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            background-size: 20px;
        }

        .state-select:hover {
            border-color: rgba(99, 102, 241, 0.5);
            background-color: rgba(30, 41, 59, 1);
        }

        .state-select:focus {
            outline: none;
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
        }

        /* ZIP Search */
        .search-container {
            display: flex;
            gap: 8px;
        }

        .zip-search {
            flex: 1;
            padding: 12px 16px;
            background: rgba(30, 41, 59, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            color: #f8fafc;
            font-size: 0.95rem;
            font-family: inherit;
            transition: all 0.2s ease;
        }

        .zip-search::placeholder {
            color: #64748b;
        }

        .zip-search:hover {
            border-color: rgba(99, 102, 241, 0.5);
            background-color: rgba(30, 41, 59, 1);
        }

        .zip-search:focus {
            outline: none;
            border-color: #6366f1;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
        }

        .search-btn {
            padding: 12px 14px;
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            border: none;
            border-radius: 10px;
            color: white;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .search-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
        }

        .search-btn:active {
            transform: translateY(0);
        }

        .search-error {
            margin-top: 8px;
            font-size: 0.8rem;
            color: #f87171;
            min-height: 1.2em;
        }

        .search-error.success {
            color: #4ade80;
        }

        /* Year Slider */
        .year-display {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .current-year {
            font-size: 2rem;
            font-weight: 700;
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .year-range {
            font-size: 0.875rem;
            color: #64748b;
        }

        .slider-container {
            position: relative;
            padding: 10px 0;
        }

        .year-slider {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: rgba(30, 41, 59, 0.8);
            outline: none;
            -webkit-appearance: none;
            cursor: pointer;
        }

        .year-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
            transition: transform 0.2s ease;
        }

        .year-slider::-webkit-slider-thumb:hover {
            transform: scale(1.15);
        }

        .year-slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            cursor: pointer;
            border: none;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
        }

        /* Play Button */
        .play-controls {
            display: flex;
            gap: 10px;
            margin-top: 12px;
        }

        .play-btn {
            flex: 1;
            padding: 10px 16px;
            background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            border: none;
            border-radius: 8px;
            color: white;
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .play-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 8px 20px rgba(99, 102, 241, 0.4);
        }

        .play-btn:active {
            transform: translateY(0);
        }

        .play-btn.playing {
            background: linear-gradient(135deg, #ef4444 0%, #f97316 100%);
        }

        /* Legend */
        .legend {
            position: absolute;
            bottom: 30px;
            left: 20px;
            z-index: 1000;
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 12px;
            padding: 16px 20px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5),
                        0 0 0 1px rgba(255, 255, 255, 0.1);
        }

        .legend-title {
            font-size: 0.75rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #64748b;
            margin-bottom: 12px;
        }

        .legend-scale {
            display: flex;
            height: 12px;
            border-radius: 6px;
            overflow: hidden;
            width: 200px;
        }

        .legend-labels {
            display: flex;
            justify-content: space-between;
            margin-top: 8px;
            font-size: 0.75rem;
            color: #94a3b8;
        }

        /* Info Panel */
        .info-panel {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 1000;
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 16px;
            padding: 20px 24px;
            min-width: 280px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5),
                        0 0 0 1px rgba(255, 255, 255, 0.1);
            display: none;
        }

        .info-panel.visible {
            display: block;
        }

        .info-zip {
            font-size: 0.875rem;
            color: #64748b;
            margin-bottom: 4px;
        }

        .info-price {
            font-size: 1.75rem;
            font-weight: 700;
            color: #f8fafc;
            margin-bottom: 8px;
        }

        .info-change {
            font-size: 0.875rem;
            padding: 4px 10px;
            border-radius: 20px;
            display: inline-block;
        }

        .info-change.positive {
            background: rgba(34, 197, 94, 0.2);
            color: #4ade80;
        }

        .info-change.negative {
            background: rgba(239, 68, 68, 0.2);
            color: #f87171;
        }

        /* Loading Overlay */
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(15, 23, 42, 0.9);
            z-index: 2000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        .loading-overlay.visible {
            opacity: 1;
            pointer-events: auto;
        }

        .loading-spinner {
            width: 48px;
            height: 48px;
            border: 3px solid rgba(99, 102, 241, 0.2);
            border-top-color: #6366f1;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .loading-text {
            margin-top: 16px;
            font-size: 0.875rem;
            color: #94a3b8;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Stats Bar */
        .stats-bar {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 1.125rem;
            font-weight: 600;
            color: #f8fafc;
        }

        .stat-label {
            font-size: 0.7rem;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .control-panel {
                width: calc(100% - 40px);
                max-width: 320px;
            }

            .info-panel {
                top: auto;
                bottom: 100px;
                right: 20px;
                left: 20px;
                min-width: auto;
            }

            .legend {
                bottom: 20px;
                left: 50%;
                transform: translateX(-50%);
            }
        }

        /* No Data Message */
        .no-data-msg {
            text-align: center;
            padding: 40px 20px;
            color: #64748b;
        }

        .no-data-msg svg {
            width: 48px;
            height: 48px;
            margin-bottom: 12px;
            opacity: 0.5;
        }
    </style>
</head>
<body>
    <div id="map"></div>

    <!-- Control Panel -->
    <div class="control-panel">
        <div class="panel-header">
            <h1 class="panel-title">üè† Home Price Explorer</h1>
            <p class="panel-subtitle">ZHVI Median Home Values by ZIP Code</p>
        </div>

        <div class="control-group">
            <label class="control-label">Search ZIP Code</label>
            <div class="search-container">
                <input type="text" id="zipSearch" class="zip-search" placeholder="Enter 5-digit ZIP..." maxlength="5" inputmode="numeric">
                <button id="searchBtn" class="search-btn">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="11" cy="11" r="8"></circle>
                        <path d="m21 21-4.35-4.35"></path>
                    </svg>
                </button>
            </div>
            <div id="searchError" class="search-error"></div>
        </div>

        <div class="control-group">
            <label class="control-label">Select State</label>
            <select id="stateSelect" class="state-select">
                <option value="">Choose a state...</option>
            </select>
        </div>

        <div class="control-group">
            <label class="control-label">Year</label>
            <div class="year-display">
                <span id="currentYear" class="current-year">2000</span>
                <span class="year-range">2000 - 2025</span>
            </div>
            <div class="slider-container">
                <input type="range" id="yearSlider" class="year-slider" min="2000" max="2025" value="2000">
            </div>
            <div class="play-controls">
                <button id="playBtn" class="play-btn">
                    <svg id="playIcon" width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M8 5v14l11-7z"/>
                    </svg>
                    <span id="playText">Play Timeline</span>
                </button>
            </div>
        </div>

        <div class="stats-bar" id="statsBar" style="display: none;">
            <div class="stat-item">
                <div class="stat-value" id="statMedian">-</div>
                <div class="stat-label">Median</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="statMin">-</div>
                <div class="stat-label">Lowest</div>
            </div>
            <div class="stat-item">
                <div class="stat-value" id="statMax">-</div>
                <div class="stat-label">Highest</div>
            </div>
        </div>
    </div>

    <!-- Info Panel (shown on hover) -->
    <div class="info-panel" id="infoPanel">
        <div class="info-zip" id="infoZip">ZIP Code</div>
        <div class="info-price" id="infoPrice">$0</div>
        <div class="info-change positive" id="infoChange">+0% since 2000</div>
    </div>

    <!-- Legend -->
    <div class="legend">
        <div class="legend-title">Median Home Value</div>
        <div class="legend-scale" id="legendScale"></div>
        <div class="legend-labels">
            <span id="legendMin">$0</span>
            <span id="legendMax">$1M+</span>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
        <div class="loading-text">Loading ZIP codes...</div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- Papa Parse for CSV -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

    <script>
        // State configuration
        const STATES = {
            'AL': { name: 'Alabama', file: 'al_alabama_zip_codes_geo.min.json', center: [32.7, -86.7], zoom: 7 },
            'AK': { name: 'Alaska', file: 'ak_alaska_zip_codes_geo.min.json', center: [64.0, -153.0], zoom: 4 },
            'AZ': { name: 'Arizona', file: 'az_arizona_zip_codes_geo.min.json', center: [34.2, -111.6], zoom: 7 },
            'AR': { name: 'Arkansas', file: 'ar_arkansas_zip_codes_geo.min.json', center: [34.8, -92.4], zoom: 7 },
            'CA': { name: 'California', file: 'ca_california_zip_codes_geo.min.json', center: [37.2, -119.4], zoom: 6 },
            'CO': { name: 'Colorado', file: 'co_colorado_zip_codes_geo.min.json', center: [39.0, -105.5], zoom: 7 },
            'CT': { name: 'Connecticut', file: 'ct_connecticut_zip_codes_geo.min.json', center: [41.6, -72.7], zoom: 9 },
            'DE': { name: 'Delaware', file: 'de_delaware_zip_codes_geo.min.json', center: [39.0, -75.5], zoom: 9 },
            'DC': { name: 'District of Columbia', file: 'dc_district_of_columbia_zip_codes_geo.min.json', center: [38.9, -77.0], zoom: 12 },
            'FL': { name: 'Florida', file: 'fl_florida_zip_codes_geo.min.json', center: [28.0, -82.5], zoom: 7 },
            'GA': { name: 'Georgia', file: 'ga_georgia_zip_codes_geo.min.json', center: [32.6, -83.4], zoom: 7 },
            'HI': { name: 'Hawaii', file: 'hi_hawaii_zip_codes_geo.min.json', center: [20.5, -157.5], zoom: 7 },
            'ID': { name: 'Idaho', file: 'id_idaho_zip_codes_geo.min.json', center: [44.4, -114.7], zoom: 6 },
            'IL': { name: 'Illinois', file: 'il_illinois_zip_codes_geo.min.json', center: [40.0, -89.2], zoom: 7 },
            'IN': { name: 'Indiana', file: 'in_indiana_zip_codes_geo.min.json', center: [40.0, -86.2], zoom: 7 },
            'IA': { name: 'Iowa', file: 'ia_iowa_zip_codes_geo.min.json', center: [42.0, -93.5], zoom: 7 },
            'KS': { name: 'Kansas', file: 'ks_kansas_zip_codes_geo.min.json', center: [38.5, -98.4], zoom: 7 },
            'KY': { name: 'Kentucky', file: 'ky_kentucky_zip_codes_geo.min.json', center: [37.8, -85.7], zoom: 7 },
            'LA': { name: 'Louisiana', file: 'la_louisiana_zip_codes_geo.min.json', center: [31.0, -92.0], zoom: 7 },
            'ME': { name: 'Maine', file: 'me_maine_zip_codes_geo.min.json', center: [45.3, -69.0], zoom: 7 },
            'MD': { name: 'Maryland', file: 'md_maryland_zip_codes_geo.min.json', center: [39.0, -76.8], zoom: 8 },
            'MA': { name: 'Massachusetts', file: 'ma_massachusetts_zip_codes_geo.min.json', center: [42.2, -71.5], zoom: 8 },
            'MI': { name: 'Michigan', file: 'mi_michigan_zip_codes_geo.min.json', center: [44.3, -85.4], zoom: 7 },
            'MN': { name: 'Minnesota', file: 'mn_minnesota_zip_codes_geo.min.json', center: [46.3, -94.3], zoom: 6 },
            'MS': { name: 'Mississippi', file: 'ms_mississippi_zip_codes_geo.min.json', center: [32.7, -89.7], zoom: 7 },
            'MO': { name: 'Missouri', file: 'mo_missouri_zip_codes_geo.min.json', center: [38.4, -92.5], zoom: 7 },
            'MT': { name: 'Montana', file: 'mt_montana_zip_codes_geo.min.json', center: [47.0, -109.6], zoom: 6 },
            'NE': { name: 'Nebraska', file: 'ne_nebraska_zip_codes_geo.min.json', center: [41.5, -99.8], zoom: 7 },
            'NV': { name: 'Nevada', file: 'nv_nevada_zip_codes_geo.min.json', center: [39.3, -116.6], zoom: 6 },
            'NH': { name: 'New Hampshire', file: 'nh_new_hampshire_zip_codes_geo.min.json', center: [43.7, -71.6], zoom: 8 },
            'NJ': { name: 'New Jersey', file: 'nj_new_jersey_zip_codes_geo.min.json', center: [40.2, -74.7], zoom: 8 },
            'NM': { name: 'New Mexico', file: 'nm_new_mexico_zip_codes_geo.min.json', center: [34.4, -106.1], zoom: 7 },
            'NY': { name: 'New York', file: 'ny_new_york_zip_codes_geo.min.json', center: [43.0, -75.5], zoom: 7 },
            'NC': { name: 'North Carolina', file: 'nc_north_carolina_zip_codes_geo.min.json', center: [35.5, -79.8], zoom: 7 },
            'ND': { name: 'North Dakota', file: 'nd_north_dakota_zip_codes_geo.min.json', center: [47.4, -100.3], zoom: 7 },
            'OH': { name: 'Ohio', file: 'oh_ohio_zip_codes_geo.min.json', center: [40.4, -82.8], zoom: 7 },
            'OK': { name: 'Oklahoma', file: 'ok_oklahoma_zip_codes_geo.min.json', center: [35.5, -97.5], zoom: 7 },
            'OR': { name: 'Oregon', file: 'or_oregon_zip_codes_geo.min.json', center: [43.9, -120.5], zoom: 7 },
            'PA': { name: 'Pennsylvania', file: 'pa_pennsylvania_zip_codes_geo.min.json', center: [41.0, -77.5], zoom: 7 },
            'RI': { name: 'Rhode Island', file: 'ri_rhode_island_zip_codes_geo.min.json', center: [41.7, -71.5], zoom: 10 },
            'SC': { name: 'South Carolina', file: 'sc_south_carolina_zip_codes_geo.min.json', center: [33.8, -80.9], zoom: 7 },
            'SD': { name: 'South Dakota', file: 'sd_south_dakota_zip_codes_geo.min.json', center: [44.4, -100.2], zoom: 7 },
            'TN': { name: 'Tennessee', file: 'tn_tennessee_zip_codes_geo.min.json', center: [35.8, -86.3], zoom: 7 },
            'TX': { name: 'Texas', file: 'tx_texas_zip_codes_geo.min.json', center: [31.5, -99.4], zoom: 6 },
            'UT': { name: 'Utah', file: 'ut_utah_zip_codes_geo.min.json', center: [39.3, -111.7], zoom: 7 },
            'VT': { name: 'Vermont', file: 'vt_vermont_zip_codes_geo.min.json', center: [44.0, -72.7], zoom: 8 },
            'VA': { name: 'Virginia', file: 'va_virginia_zip_codes_geo.min.json', center: [37.5, -78.8], zoom: 7 },
            'WA': { name: 'Washington', file: 'wa_washington_zip_codes_geo.min.json', center: [47.4, -120.5], zoom: 7 },
            'WV': { name: 'West Virginia', file: 'wv_west_virginia_zip_codes_geo.min.json', center: [38.9, -80.4], zoom: 7 },
            'WI': { name: 'Wisconsin', file: 'wi_wisconsin_zip_codes_geo.min.json', center: [44.6, -89.7], zoom: 7 },
            'WY': { name: 'Wyoming', file: 'wy_wyoming_zip_codes_geo.min.json', center: [43.0, -107.5], zoom: 7 }
        };

        // Color palette for price ranges
        const COLORS = [
            '#1e3a5f', // Very low
            '#1e5a7e', 
            '#22839e', 
            '#3ab0a1', 
            '#7dd3c0',
            '#a8e6cf',
            '#fff3b0',
            '#ffce54',
            '#fc9f5b',
            '#f76c5e',
            '#d62839'  // Very high
        ];

        // Application state
        let map;
        let currentLayer = null;
        let zhviData = {};
        let currentYear = 2000;
        let currentState = null;
        let isPlaying = false;
        let playInterval = null;
        let priceRange = { min: 0, max: 1000000 };

        // Initialize the map
        function initMap() {
            map = L.map('map', {
                center: [39.8, -98.5],
                zoom: 4,
                zoomControl: true,
                attributionControl: true,
                preferCanvas: true  // Use Canvas renderer for smoother polygon edges
            });

            // Dark map tiles
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> &copy; <a href="https://carto.com/attributions">CARTO</a>',
                subdomains: 'abcd',
                maxZoom: 19
            }).addTo(map);

            // Build legend gradient
            buildLegend();
        }

        // Build the color legend
        function buildLegend() {
            const legendScale = document.getElementById('legendScale');
            legendScale.innerHTML = COLORS.map(color => 
                `<div style="flex:1;background:${color}"></div>`
            ).join('');
        }

        // Populate state dropdown
        function populateStateDropdown() {
            const select = document.getElementById('stateSelect');
            const sortedStates = Object.entries(STATES)
                .sort((a, b) => a[1].name.localeCompare(b[1].name));
            
            sortedStates.forEach(([abbr, state]) => {
                const option = document.createElement('option');
                option.value = abbr;
                option.textContent = state.name;
                select.appendChild(option);
            });
        }

        // Load CSV data
        async function loadZHVIData() {
            return new Promise((resolve, reject) => {
                Papa.parse('ZHVI_WI.csv', {
                    download: true,
                    header: true,
                    complete: (results) => {
                        results.data.forEach(row => {
                            if (row.Zip_Code) {
                                // Pad ZIP code to 5 digits
                                const zip = row.Zip_Code.toString().padStart(5, '0');
                                zhviData[zip] = row;
                            }
                        });
                        console.log(`Loaded ${Object.keys(zhviData).length} ZIP codes with price data`);
                        resolve();
                    },
                    error: (err) => reject(err)
                });
            });
        }

        // Load state GeoJSON
        async function loadStateGeoJSON(stateAbbr) {
            const state = STATES[stateAbbr];
            if (!state) return null;

            showLoading(true);
            
            try {
                const response = await fetch(`geojsons/${state.file}`);
                const geojson = await response.json();
                console.log(`Loaded ${geojson.features.length} ZIP code boundaries for ${state.name}`);
                return geojson;
            } catch (err) {
                console.error('Failed to load GeoJSON:', err);
                return null;
            } finally {
                showLoading(false);
            }
        }

        // Get color based on price
        function getColor(price) {
            if (!price || price === 0) return '#2a2a40';
            
            const normalized = (price - priceRange.min) / (priceRange.max - priceRange.min);
            const index = Math.min(Math.floor(normalized * COLORS.length), COLORS.length - 1);
            return COLORS[Math.max(0, index)];
        }

        // Format currency
        function formatCurrency(value) {
            if (!value) return 'N/A';
            if (value >= 1000000) {
                return '$' + (value / 1000000).toFixed(2) + 'M';
            } else if (value >= 1000) {
                return '$' + (value / 1000).toFixed(0) + 'K';
            }
            return '$' + value.toLocaleString();
        }

        // Calculate price range for current state/year
        function calculatePriceRange(geojson) {
            const prices = [];
            
            geojson.features.forEach(feature => {
                const zip = feature.properties.ZCTA5CE10;
                const data = zhviData[zip];
                if (data && data[currentYear]) {
                    const price = parseFloat(data[currentYear]);
                    if (!isNaN(price) && price > 0) {
                        prices.push(price);
                    }
                }
            });

            if (prices.length === 0) {
                return { min: 0, max: 1000000, median: 0, count: 0 };
            }

            prices.sort((a, b) => a - b);
            
            // Use percentiles to avoid outlier skewing
            const p5 = prices[Math.floor(prices.length * 0.05)];
            const p95 = prices[Math.floor(prices.length * 0.95)];
            const median = prices[Math.floor(prices.length * 0.5)];
            
            return {
                min: p5,
                max: p95,
                median: median,
                lowest: prices[0],
                highest: prices[prices.length - 1],
                count: prices.length
            };
        }

        // Style function for GeoJSON
        function styleFeature(feature) {
            const zip = feature.properties.ZCTA5CE10;
            const data = zhviData[zip];
            let price = 0;
            
            if (data && data[currentYear]) {
                price = parseFloat(data[currentYear]) || 0;
            }

            return {
                fillColor: getColor(price),
                weight: 1,
                opacity: 0.6,
                color: '#1a1a2e',
                fillOpacity: 0.4,
                lineCap: 'round',
                lineJoin: 'round'
            };
        }

        // Handle feature hover/click
        function onEachFeature(feature, layer) {
            layer.on({
                mouseover: (e) => highlightFeature(e, feature),
                mouseout: resetHighlight,
                click: (e) => zoomToFeature(e, feature)
            });
        }

        // Highlight feature on hover
        function highlightFeature(e, feature) {
            const layer = e.target;
            
            layer.setStyle({
                weight: 2.5,
                color: '#ffffff',
                fillOpacity: 1,
                lineCap: 'round',
                lineJoin: 'round'
            });

            layer.bringToFront();

            // Update info panel
            const zip = feature.properties.ZCTA5CE10;
            const data = zhviData[zip];
            
            const infoPanel = document.getElementById('infoPanel');
            const infoZip = document.getElementById('infoZip');
            const infoPrice = document.getElementById('infoPrice');
            const infoChange = document.getElementById('infoChange');

            if (data) {
                const currentPrice = parseFloat(data[currentYear]) || 0;
                const basePrice = parseFloat(data['2000']) || 0;
                
                infoZip.textContent = `ZIP Code: ${zip}`;
                infoPrice.textContent = formatCurrency(currentPrice);
                
                if (basePrice > 0 && currentPrice > 0) {
                    const change = ((currentPrice - basePrice) / basePrice * 100).toFixed(1);
                    const isPositive = change >= 0;
                    infoChange.textContent = `${isPositive ? '+' : ''}${change}% since 2000`;
                    infoChange.className = `info-change ${isPositive ? 'positive' : 'negative'}`;
                } else {
                    infoChange.textContent = 'No historical data';
                    infoChange.className = 'info-change';
                }
            } else {
                infoZip.textContent = `ZIP Code: ${zip}`;
                infoPrice.textContent = 'No data';
                infoChange.textContent = '';
                infoChange.className = 'info-change';
            }

            infoPanel.classList.add('visible');
        }

        // Reset highlight
        function resetHighlight(e) {
            if (currentLayer) {
                currentLayer.resetStyle(e.target);
            }
            document.getElementById('infoPanel').classList.remove('visible');
        }

        // Zoom to feature on click
        function zoomToFeature(e, feature) {
            map.fitBounds(e.target.getBounds(), { padding: [50, 50] });
        }

        // Render the state data
        async function renderState(stateAbbr) {
            if (!stateAbbr) return;

            currentState = stateAbbr;
            const state = STATES[stateAbbr];
            
            // Remove existing layer
            if (currentLayer) {
                map.removeLayer(currentLayer);
            }

            // Load GeoJSON
            const geojson = await loadStateGeoJSON(stateAbbr);
            if (!geojson) return;

            // Store for later updates
            currentLayer = L.geoJSON(geojson, {
                style: styleFeature,
                onEachFeature: onEachFeature
            });

            // Calculate price range
            const range = calculatePriceRange(geojson);
            priceRange = { min: range.min, max: range.max };

            // Update legend
            document.getElementById('legendMin').textContent = formatCurrency(range.min);
            document.getElementById('legendMax').textContent = formatCurrency(range.max);

            // Update stats
            updateStats(range);

            // Re-style with correct price range
            currentLayer.setStyle(styleFeature);
            
            // Add to map and zoom
            currentLayer.addTo(map);
            map.flyTo(state.center, state.zoom, { duration: 1 });
        }

        // Update statistics display
        function updateStats(range) {
            const statsBar = document.getElementById('statsBar');
            statsBar.style.display = 'grid';

            document.getElementById('statMedian').textContent = formatCurrency(range.median);
            document.getElementById('statMin').textContent = formatCurrency(range.lowest);
            document.getElementById('statMax').textContent = formatCurrency(range.highest);
        }

        // Update the year display and re-render
        function updateYear(year) {
            currentYear = parseInt(year);
            document.getElementById('currentYear').textContent = currentYear;
            document.getElementById('yearSlider').value = currentYear;

            if (currentLayer && currentState) {
                // Recalculate price range for the new year
                fetch(`geojsons/${STATES[currentState].file}`)
                    .then(res => res.json())
                    .then(geojson => {
                        const range = calculatePriceRange(geojson);
                        priceRange = { min: range.min, max: range.max };
                        
                        // Update legend
                        document.getElementById('legendMin').textContent = formatCurrency(range.min);
                        document.getElementById('legendMax').textContent = formatCurrency(range.max);
                        
                        // Update stats
                        updateStats(range);
                        
                        // Re-style layer
                        currentLayer.setStyle(styleFeature);
                    });
            }
        }

        // Play timeline animation
        function togglePlay() {
            const btn = document.getElementById('playBtn');
            const icon = document.getElementById('playIcon');
            const text = document.getElementById('playText');

            if (isPlaying) {
                // Stop
                clearInterval(playInterval);
                isPlaying = false;
                btn.classList.remove('playing');
                icon.innerHTML = '<path d="M8 5v14l11-7z"/>';
                text.textContent = 'Play Timeline';
            } else {
                // Play
                isPlaying = true;
                btn.classList.add('playing');
                icon.innerHTML = '<rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/>';
                text.textContent = 'Pause';

                // Reset to 2000 if at end
                if (currentYear >= 2025) {
                    updateYear(2000);
                }

                playInterval = setInterval(() => {
                    if (currentYear >= 2025) {
                        togglePlay(); // Stop at end
                        return;
                    }
                    updateYear(currentYear + 1);
                }, 800);
            }
        }

        // Show/hide loading overlay
        function showLoading(show) {
            const overlay = document.getElementById('loadingOverlay');
            if (show) {
                overlay.classList.add('visible');
            } else {
                overlay.classList.remove('visible');
            }
        }

        // ZIP code to state mapping (first 3 digits)
        const ZIP_STATE_MAP = {
            '005': 'NY', '006': 'PR', '007': 'PR', '008': 'PR', '009': 'PR',
            '010': 'MA', '011': 'MA', '012': 'MA', '013': 'MA', '014': 'MA', '015': 'MA', '016': 'MA', '017': 'MA', '018': 'MA', '019': 'MA',
            '020': 'MA', '021': 'MA', '022': 'MA', '023': 'MA', '024': 'MA', '025': 'MA', '026': 'MA', '027': 'MA',
            '028': 'RI', '029': 'RI',
            '030': 'NH', '031': 'NH', '032': 'NH', '033': 'NH', '034': 'NH', '035': 'NH', '036': 'NH', '037': 'NH', '038': 'NH',
            '039': 'ME', '040': 'ME', '041': 'ME', '042': 'ME', '043': 'ME', '044': 'ME', '045': 'ME', '046': 'ME', '047': 'ME', '048': 'ME', '049': 'ME',
            '050': 'VT', '051': 'VT', '052': 'VT', '053': 'VT', '054': 'VT', '055': 'VT', '056': 'VT', '057': 'VT', '058': 'VT', '059': 'VT',
            '060': 'CT', '061': 'CT', '062': 'CT', '063': 'CT', '064': 'CT', '065': 'CT', '066': 'CT', '067': 'CT', '068': 'CT', '069': 'CT',
            '070': 'NJ', '071': 'NJ', '072': 'NJ', '073': 'NJ', '074': 'NJ', '075': 'NJ', '076': 'NJ', '077': 'NJ', '078': 'NJ', '079': 'NJ',
            '080': 'NJ', '081': 'NJ', '082': 'NJ', '083': 'NJ', '084': 'NJ', '085': 'NJ', '086': 'NJ', '087': 'NJ', '088': 'NJ', '089': 'NJ',
            '100': 'NY', '101': 'NY', '102': 'NY', '103': 'NY', '104': 'NY', '105': 'NY', '106': 'NY', '107': 'NY', '108': 'NY', '109': 'NY',
            '110': 'NY', '111': 'NY', '112': 'NY', '113': 'NY', '114': 'NY', '115': 'NY', '116': 'NY', '117': 'NY', '118': 'NY', '119': 'NY',
            '120': 'NY', '121': 'NY', '122': 'NY', '123': 'NY', '124': 'NY', '125': 'NY', '126': 'NY', '127': 'NY', '128': 'NY', '129': 'NY',
            '130': 'NY', '131': 'NY', '132': 'NY', '133': 'NY', '134': 'NY', '135': 'NY', '136': 'NY', '137': 'NY', '138': 'NY', '139': 'NY',
            '140': 'NY', '141': 'NY', '142': 'NY', '143': 'NY', '144': 'NY', '145': 'NY', '146': 'NY', '147': 'NY', '148': 'NY', '149': 'NY',
            '150': 'PA', '151': 'PA', '152': 'PA', '153': 'PA', '154': 'PA', '155': 'PA', '156': 'PA', '157': 'PA', '158': 'PA', '159': 'PA',
            '160': 'PA', '161': 'PA', '162': 'PA', '163': 'PA', '164': 'PA', '165': 'PA', '166': 'PA', '167': 'PA', '168': 'PA', '169': 'PA',
            '170': 'PA', '171': 'PA', '172': 'PA', '173': 'PA', '174': 'PA', '175': 'PA', '176': 'PA', '177': 'PA', '178': 'PA', '179': 'PA',
            '180': 'PA', '181': 'PA', '182': 'PA', '183': 'PA', '184': 'PA', '185': 'PA', '186': 'PA', '187': 'PA', '188': 'PA', '189': 'PA',
            '190': 'PA', '191': 'PA', '192': 'PA', '193': 'PA', '194': 'PA', '195': 'PA', '196': 'PA',
            '197': 'DE', '198': 'DE', '199': 'DE',
            '200': 'DC', '201': 'VA', '202': 'DC', '203': 'DC', '204': 'DC', '205': 'DC',
            '206': 'MD', '207': 'MD', '208': 'MD', '209': 'MD', '210': 'MD', '211': 'MD', '212': 'MD', '214': 'MD', '215': 'MD', '216': 'MD', '217': 'MD', '218': 'MD', '219': 'MD',
            '220': 'VA', '221': 'VA', '222': 'VA', '223': 'VA', '224': 'VA', '225': 'VA', '226': 'VA', '227': 'VA', '228': 'VA', '229': 'VA',
            '230': 'VA', '231': 'VA', '232': 'VA', '233': 'VA', '234': 'VA', '235': 'VA', '236': 'VA', '237': 'VA', '238': 'VA', '239': 'VA',
            '240': 'VA', '241': 'VA', '242': 'VA', '243': 'VA', '244': 'VA', '245': 'VA', '246': 'VA',
            '247': 'WV', '248': 'WV', '249': 'WV', '250': 'WV', '251': 'WV', '252': 'WV', '253': 'WV', '254': 'WV', '255': 'WV', '256': 'WV', '257': 'WV', '258': 'WV', '259': 'WV',
            '260': 'WV', '261': 'WV', '262': 'WV', '263': 'WV', '264': 'WV', '265': 'WV', '266': 'WV', '267': 'WV', '268': 'WV',
            '270': 'NC', '271': 'NC', '272': 'NC', '273': 'NC', '274': 'NC', '275': 'NC', '276': 'NC', '277': 'NC', '278': 'NC', '279': 'NC',
            '280': 'NC', '281': 'NC', '282': 'NC', '283': 'NC', '284': 'NC', '285': 'NC', '286': 'NC', '287': 'NC', '288': 'NC', '289': 'NC',
            '290': 'SC', '291': 'SC', '292': 'SC', '293': 'SC', '294': 'SC', '295': 'SC', '296': 'SC', '297': 'SC', '298': 'SC', '299': 'SC',
            '300': 'GA', '301': 'GA', '302': 'GA', '303': 'GA', '304': 'GA', '305': 'GA', '306': 'GA', '307': 'GA', '308': 'GA', '309': 'GA',
            '310': 'GA', '311': 'GA', '312': 'GA', '313': 'GA', '314': 'GA', '315': 'GA', '316': 'GA', '317': 'GA', '318': 'GA', '319': 'GA',
            '320': 'FL', '321': 'FL', '322': 'FL', '323': 'FL', '324': 'FL', '325': 'FL', '326': 'FL', '327': 'FL', '328': 'FL', '329': 'FL',
            '330': 'FL', '331': 'FL', '332': 'FL', '333': 'FL', '334': 'FL', '335': 'FL', '336': 'FL', '337': 'FL', '338': 'FL', '339': 'FL',
            '340': 'FL', '341': 'FL', '342': 'FL', '344': 'FL', '346': 'FL', '347': 'FL', '349': 'FL',
            '350': 'AL', '351': 'AL', '352': 'AL', '354': 'AL', '355': 'AL', '356': 'AL', '357': 'AL', '358': 'AL', '359': 'AL',
            '360': 'AL', '361': 'AL', '362': 'AL', '363': 'AL', '364': 'AL', '365': 'AL', '366': 'AL', '367': 'AL', '368': 'AL', '369': 'AL',
            '370': 'TN', '371': 'TN', '372': 'TN', '373': 'TN', '374': 'TN', '375': 'TN', '376': 'TN', '377': 'TN', '378': 'TN', '379': 'TN',
            '380': 'TN', '381': 'TN', '382': 'TN', '383': 'TN', '384': 'TN', '385': 'TN',
            '386': 'MS', '387': 'MS', '388': 'MS', '389': 'MS', '390': 'MS', '391': 'MS', '392': 'MS', '393': 'MS', '394': 'MS', '395': 'MS', '396': 'MS', '397': 'MS',
            '400': 'KY', '401': 'KY', '402': 'KY', '403': 'KY', '404': 'KY', '405': 'KY', '406': 'KY', '407': 'KY', '408': 'KY', '409': 'KY',
            '410': 'KY', '411': 'KY', '412': 'KY', '413': 'KY', '414': 'KY', '415': 'KY', '416': 'KY', '417': 'KY', '418': 'KY',
            '420': 'KY', '421': 'KY', '422': 'KY', '423': 'KY', '424': 'KY', '425': 'KY', '426': 'KY', '427': 'KY',
            '430': 'OH', '431': 'OH', '432': 'OH', '433': 'OH', '434': 'OH', '435': 'OH', '436': 'OH', '437': 'OH', '438': 'OH', '439': 'OH',
            '440': 'OH', '441': 'OH', '442': 'OH', '443': 'OH', '444': 'OH', '445': 'OH', '446': 'OH', '447': 'OH', '448': 'OH', '449': 'OH',
            '450': 'OH', '451': 'OH', '452': 'OH', '453': 'OH', '454': 'OH', '455': 'OH', '456': 'OH', '457': 'OH', '458': 'OH', '459': 'OH',
            '460': 'IN', '461': 'IN', '462': 'IN', '463': 'IN', '464': 'IN', '465': 'IN', '466': 'IN', '467': 'IN', '468': 'IN', '469': 'IN',
            '470': 'IN', '471': 'IN', '472': 'IN', '473': 'IN', '474': 'IN', '475': 'IN', '476': 'IN', '477': 'IN', '478': 'IN', '479': 'IN',
            '480': 'MI', '481': 'MI', '482': 'MI', '483': 'MI', '484': 'MI', '485': 'MI', '486': 'MI', '487': 'MI', '488': 'MI', '489': 'MI',
            '490': 'MI', '491': 'MI', '492': 'MI', '493': 'MI', '494': 'MI', '495': 'MI', '496': 'MI', '497': 'MI', '498': 'MI', '499': 'MI',
            '500': 'IA', '501': 'IA', '502': 'IA', '503': 'IA', '504': 'IA', '505': 'IA', '506': 'IA', '507': 'IA', '508': 'IA', '509': 'IA',
            '510': 'IA', '511': 'IA', '512': 'IA', '513': 'IA', '514': 'IA', '515': 'IA', '516': 'IA', '520': 'IA', '521': 'IA', '522': 'IA', '523': 'IA', '524': 'IA', '525': 'IA', '526': 'IA', '527': 'IA', '528': 'IA',
            '530': 'WI', '531': 'WI', '532': 'WI', '534': 'WI', '535': 'WI', '537': 'WI', '538': 'WI', '539': 'WI',
            '540': 'WI', '541': 'WI', '542': 'WI', '543': 'WI', '544': 'WI', '545': 'WI', '546': 'WI', '547': 'WI', '548': 'WI', '549': 'WI',
            '550': 'MN', '551': 'MN', '553': 'MN', '554': 'MN', '555': 'MN', '556': 'MN', '557': 'MN', '558': 'MN', '559': 'MN',
            '560': 'MN', '561': 'MN', '562': 'MN', '563': 'MN', '564': 'MN', '565': 'MN', '566': 'MN', '567': 'MN',
            '570': 'SD', '571': 'SD', '572': 'SD', '573': 'SD', '574': 'SD', '575': 'SD', '576': 'SD', '577': 'SD',
            '580': 'ND', '581': 'ND', '582': 'ND', '583': 'ND', '584': 'ND', '585': 'ND', '586': 'ND', '587': 'ND', '588': 'ND',
            '590': 'MT', '591': 'MT', '592': 'MT', '593': 'MT', '594': 'MT', '595': 'MT', '596': 'MT', '597': 'MT', '598': 'MT', '599': 'MT',
            '600': 'IL', '601': 'IL', '602': 'IL', '603': 'IL', '604': 'IL', '605': 'IL', '606': 'IL', '607': 'IL', '608': 'IL', '609': 'IL',
            '610': 'IL', '611': 'IL', '612': 'IL', '613': 'IL', '614': 'IL', '615': 'IL', '616': 'IL', '617': 'IL', '618': 'IL', '619': 'IL',
            '620': 'IL', '622': 'IL', '623': 'IL', '624': 'IL', '625': 'IL', '626': 'IL', '627': 'IL', '628': 'IL', '629': 'IL',
            '630': 'MO', '631': 'MO', '633': 'MO', '634': 'MO', '635': 'MO', '636': 'MO', '637': 'MO', '638': 'MO', '639': 'MO',
            '640': 'MO', '641': 'MO', '644': 'MO', '645': 'MO', '646': 'MO', '647': 'MO', '648': 'MO', '649': 'MO',
            '650': 'MO', '651': 'MO', '652': 'MO', '653': 'MO', '654': 'MO', '655': 'MO', '656': 'MO', '657': 'MO', '658': 'MO',
            '660': 'KS', '661': 'KS', '662': 'KS', '664': 'KS', '665': 'KS', '666': 'KS', '667': 'KS', '668': 'KS', '669': 'KS',
            '670': 'KS', '671': 'KS', '672': 'KS', '673': 'KS', '674': 'KS', '675': 'KS', '676': 'KS', '677': 'KS', '678': 'KS', '679': 'KS',
            '680': 'NE', '681': 'NE', '683': 'NE', '684': 'NE', '685': 'NE', '686': 'NE', '687': 'NE', '688': 'NE', '689': 'NE',
            '690': 'NE', '691': 'NE', '692': 'NE', '693': 'NE',
            '700': 'LA', '701': 'LA', '703': 'LA', '704': 'LA', '705': 'LA', '706': 'LA', '707': 'LA', '708': 'LA',
            '710': 'LA', '711': 'LA', '712': 'LA', '713': 'LA', '714': 'LA',
            '716': 'AR', '717': 'AR', '718': 'AR', '719': 'AR', '720': 'AR', '721': 'AR', '722': 'AR', '723': 'AR', '724': 'AR', '725': 'AR', '726': 'AR', '727': 'AR', '728': 'AR', '729': 'AR',
            '730': 'OK', '731': 'OK', '734': 'OK', '735': 'OK', '736': 'OK', '737': 'OK', '738': 'OK', '739': 'OK',
            '740': 'OK', '741': 'OK', '743': 'OK', '744': 'OK', '745': 'OK', '746': 'OK', '747': 'OK', '748': 'OK', '749': 'OK',
            '750': 'TX', '751': 'TX', '752': 'TX', '753': 'TX', '754': 'TX', '755': 'TX', '756': 'TX', '757': 'TX', '758': 'TX', '759': 'TX',
            '760': 'TX', '761': 'TX', '762': 'TX', '763': 'TX', '764': 'TX', '765': 'TX', '766': 'TX', '767': 'TX', '768': 'TX', '769': 'TX',
            '770': 'TX', '771': 'TX', '772': 'TX', '773': 'TX', '774': 'TX', '775': 'TX', '776': 'TX', '777': 'TX', '778': 'TX', '779': 'TX',
            '780': 'TX', '781': 'TX', '782': 'TX', '783': 'TX', '784': 'TX', '785': 'TX', '786': 'TX', '787': 'TX', '788': 'TX', '789': 'TX',
            '790': 'TX', '791': 'TX', '792': 'TX', '793': 'TX', '794': 'TX', '795': 'TX', '796': 'TX', '797': 'TX', '798': 'TX', '799': 'TX',
            '800': 'CO', '801': 'CO', '802': 'CO', '803': 'CO', '804': 'CO', '805': 'CO', '806': 'CO', '807': 'CO', '808': 'CO', '809': 'CO',
            '810': 'CO', '811': 'CO', '812': 'CO', '813': 'CO', '814': 'CO', '815': 'CO', '816': 'CO',
            '820': 'WY', '821': 'WY', '822': 'WY', '823': 'WY', '824': 'WY', '825': 'WY', '826': 'WY', '827': 'WY', '828': 'WY', '829': 'WY', '830': 'WY', '831': 'WY',
            '832': 'ID', '833': 'ID', '834': 'ID', '835': 'ID', '836': 'ID', '837': 'ID', '838': 'ID',
            '840': 'UT', '841': 'UT', '842': 'UT', '843': 'UT', '844': 'UT', '845': 'UT', '846': 'UT', '847': 'UT',
            '850': 'AZ', '851': 'AZ', '852': 'AZ', '853': 'AZ', '855': 'AZ', '856': 'AZ', '857': 'AZ', '859': 'AZ', '860': 'AZ', '863': 'AZ', '864': 'AZ', '865': 'AZ',
            '870': 'NM', '871': 'NM', '872': 'NM', '873': 'NM', '874': 'NM', '875': 'NM', '877': 'NM', '878': 'NM', '879': 'NM',
            '880': 'NM', '881': 'NM', '882': 'NM', '883': 'NM', '884': 'NM',
            '889': 'NV', '890': 'NV', '891': 'NV', '893': 'NV', '894': 'NV', '895': 'NV', '897': 'NV', '898': 'NV',
            '900': 'CA', '901': 'CA', '902': 'CA', '903': 'CA', '904': 'CA', '905': 'CA', '906': 'CA', '907': 'CA', '908': 'CA', '909': 'CA',
            '910': 'CA', '911': 'CA', '912': 'CA', '913': 'CA', '914': 'CA', '915': 'CA', '916': 'CA', '917': 'CA', '918': 'CA', '919': 'CA',
            '920': 'CA', '921': 'CA', '922': 'CA', '923': 'CA', '924': 'CA', '925': 'CA', '926': 'CA', '927': 'CA', '928': 'CA',
            '930': 'CA', '931': 'CA', '932': 'CA', '933': 'CA', '934': 'CA', '935': 'CA', '936': 'CA', '937': 'CA', '938': 'CA', '939': 'CA',
            '940': 'CA', '941': 'CA', '942': 'CA', '943': 'CA', '944': 'CA', '945': 'CA', '946': 'CA', '947': 'CA', '948': 'CA', '949': 'CA',
            '950': 'CA', '951': 'CA', '952': 'CA', '953': 'CA', '954': 'CA', '955': 'CA', '956': 'CA', '957': 'CA', '958': 'CA', '959': 'CA',
            '960': 'CA', '961': 'CA',
            '967': 'HI', '968': 'HI',
            '970': 'OR', '971': 'OR', '972': 'OR', '973': 'OR', '974': 'OR', '975': 'OR', '976': 'OR', '977': 'OR', '978': 'OR', '979': 'OR',
            '980': 'WA', '981': 'WA', '982': 'WA', '983': 'WA', '984': 'WA', '985': 'WA', '986': 'WA', '988': 'WA', '989': 'WA',
            '990': 'WA', '991': 'WA', '992': 'WA', '993': 'WA', '994': 'WA',
            '995': 'AK', '996': 'AK', '997': 'AK', '998': 'AK', '999': 'AK'
        };

        // Get state from ZIP code
        function getStateFromZip(zip) {
            const prefix = zip.substring(0, 3);
            return ZIP_STATE_MAP[prefix] || null;
        }

        // Search for a ZIP code
        async function searchZipCode(zip) {
            const searchError = document.getElementById('searchError');
            
            // Validate input
            if (!zip || zip.length !== 5) {
                searchError.textContent = 'Please enter a valid 5-digit ZIP code';
                searchError.className = 'search-error';
                return;
            }

            // Check if we have price data for this ZIP
            const hasData = zhviData[zip];
            
            // Get the state for this ZIP
            const stateAbbr = getStateFromZip(zip);
            
            if (!stateAbbr || !STATES[stateAbbr]) {
                searchError.textContent = 'ZIP code not found in our database';
                searchError.className = 'search-error';
                return;
            }

            // Load the state if needed
            if (currentState !== stateAbbr) {
                document.getElementById('stateSelect').value = stateAbbr;
                await renderState(stateAbbr);
            }

            // Find and highlight the ZIP code polygon
            let found = false;
            currentLayer.eachLayer((layer) => {
                const layerZip = layer.feature.properties.ZCTA5CE10;
                if (layerZip === zip) {
                    found = true;
                    
                    // Zoom to the feature
                    map.fitBounds(layer.getBounds(), { padding: [100, 100], maxZoom: 12 });
                    
                    // Highlight it
                    layer.setStyle({
                        weight: 3,
                        color: '#fbbf24',
                        fillOpacity: 1
                    });
                    layer.bringToFront();

                    // Show info
                    const data = zhviData[zip];
                    if (data) {
                        const price = parseFloat(data[currentYear]) || 0;
                        searchError.textContent = `Found! ${formatCurrency(price)} in ${currentYear}`;
                        searchError.className = 'search-error success';
                    } else {
                        searchError.textContent = 'ZIP found but no price data available';
                        searchError.className = 'search-error';
                    }

                    // Reset highlight after 3 seconds
                    setTimeout(() => {
                        if (currentLayer) {
                            currentLayer.resetStyle(layer);
                        }
                    }, 3000);
                }
            });

            if (!found) {
                searchError.textContent = 'ZIP code boundary not found in map data';
                searchError.className = 'search-error';
            }
        }

        // Initialize everything
        async function init() {
            initMap();
            populateStateDropdown();
            
            showLoading(true);
            await loadZHVIData();
            showLoading(false);

            // Event listeners
            document.getElementById('stateSelect').addEventListener('change', (e) => {
                renderState(e.target.value);
            });

            document.getElementById('yearSlider').addEventListener('input', (e) => {
                updateYear(e.target.value);
            });

            document.getElementById('playBtn').addEventListener('click', togglePlay);

            // ZIP search functionality
            const zipSearch = document.getElementById('zipSearch');
            const searchBtn = document.getElementById('searchBtn');
            const searchError = document.getElementById('searchError');

            // Only allow numbers in the input
            zipSearch.addEventListener('input', (e) => {
                e.target.value = e.target.value.replace(/\D/g, '').slice(0, 5);
                searchError.textContent = '';
            });

            // Search on button click
            searchBtn.addEventListener('click', () => {
                searchZipCode(zipSearch.value);
            });

            // Search on Enter key
            zipSearch.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    searchZipCode(zipSearch.value);
                }
            });

            console.log('ZHVI Map initialized successfully!');
        }

        // Start the app
        init();
    </script>
</body>
</html>
